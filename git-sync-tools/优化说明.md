# Git自动同步工具 - 优化说明

## 🎯 优化概述

本次优化解决了原同步工具的关键问题，增强了功能性和可靠性，并提供了跨平台支持。

## ✨ 主要优化内容

### 1. 补齐缺失的计划任务脚本
- **新增文件**: `setup-auto-sync.ps1`
- **功能**: 读取配置文件，创建Windows计划任务
- **特性**: 
  - 自动验证配置完整性
  - 检查管理员权限
  - 支持任务覆盖和重新创建
  - 详细的错误处理和日志记录

### 2. 核心同步脚本优化
- **文件**: `auto-sync.ps1`
- **主要改进**:
  - ✅ 读取配置文件 `auto-sync-config.json`
  - ✅ 修复 `git add -A` 包含删除文件
  - ✅ 增强智能拉取策略（rebase + autostash）
  - ✅ 详细的Git状态检测和报告
  - ✅ 改进的错误处理和日志记录
  - ✅ 支持配置参数覆盖

### 3. 跨平台支持
- **新增文件**: `auto-sync.sh` (Linux版本)
- **新增文件**: `setup-auto-sync.sh` (Linux设置脚本)
- **特性**:
  - 完整的bash脚本实现
  - 彩色日志输出
  - cron任务自动设置
  - 配置文件支持（需要jq）
  - 与PowerShell版本功能对等

### 4. 配置文件增强
- **文件**: `auto-sync-config.json`
- **新增配置项**:
  - 通知设置（邮件、webhook、桌面通知）
  - 备份配置（自动备份、版本管理）
  - 文件过滤（排除/包含规则）
  - 高级Git配置
  - 钩子脚本支持
  - 超时和文件大小限制

## 🔧 技术改进

### 同步策略优化
```bash
# 原版本
git add .                    # 不包含删除文件
git pull origin main         # 简单拉取，无冲突处理

# 优化版本
git add -A                   # 包含所有更改（包括删除）
git pull --rebase --autostash origin main  # 智能拉取
```

### 错误处理增强
- 详细的错误信息记录
- 多策略拉取（rebase → merge 备用）
- 状态检测和报告
- 优雅的失败处理

### 配置管理
- 统一的配置文件格式
- 参数验证和默认值
- 配置热加载
- 跨平台兼容

## 📋 使用指南

### Windows用户
1. **快速设置**:
   ```cmd
   # 以管理员身份运行
   git-sync-tools\setup-git-auto-sync.bat
   ```

2. **手动设置**:
   ```powershell
   # 配置仓库信息
   git-sync-tools\配置向导.ps1
   
   # 创建计划任务
   git-sync-tools\setup-auto-sync.ps1
   ```

3. **GUI配置**:
   ```cmd
   git-sync-tools\启动Git自动同步GUI.bat
   ```

### Linux用户
1. **快速设置**:
   ```bash
   # 设置执行权限
   chmod +x git-sync-tools/setup-auto-sync.sh
   chmod +x git-sync-tools/auto-sync.sh
   
   # 运行设置脚本
   ./git-sync-tools/setup-auto-sync.sh
   ```

2. **手动配置**:
   ```bash
   # 编辑配置文件
   vim git-sync-tools/auto-sync-config.json
   
   # 手动执行同步
   ./git-sync-tools/auto-sync.sh --path /path/to/repo
   
   # 设置cron任务
   crontab -e
   # 添加: */5 * * * * /path/to/auto-sync.sh --silent
   ```

## ⚙️ 配置说明

### 基本配置
```json
{
    "sync": {
        "enabled": true,           // 启用同步
        "interval": 5,             // 同步间隔（分钟）
        "repoPath": "/workspace",  // 仓库路径
        "remote": "origin",        // 远程仓库
        "branch": "main",          // 分支名称
        "autoCommit": true,        // 自动提交
        "autoPush": true,          // 自动推送
        "conflictStrategy": "rebase" // 冲突处理策略
    }
}
```

### 高级配置
```json
{
    "backup": {
        "enabled": true,           // 启用备份
        "backupPath": "backup",    // 备份路径
        "maxBackups": 10,          // 最大备份数
        "backupBeforeSync": true   // 同步前备份
    },
    "filters": {
        "excludeFiles": [          // 排除文件
            "*.tmp", "*.log", "node_modules/"
        ],
        "includeFiles": [          // 包含文件
            "*.js", "*.html", "*.md"
        ]
    }
}
```

## 🔍 故障排除

### 常见问题

**Q: 计划任务创建失败？**
A: 
- Windows: 确保以管理员身份运行
- Linux: 检查cron服务状态 `systemctl status cron`

**Q: 同步失败，显示权限错误？**
A: 配置Git身份验证
```bash
# SSH密钥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 或Personal Access Token
git config --global credential.helper store
```

**Q: 配置文件读取失败？**
A: 
- 检查JSON格式是否正确
- Linux: 安装jq `sudo apt-get install jq`

**Q: 冲突无法自动解决？**
A: 
- 查看日志文件获取详细信息
- 手动解决冲突后重新同步
- 考虑调整 `conflictStrategy` 设置

### 调试模式
```bash
# Windows
.\auto-sync.ps1 -Silent:$false

# Linux
./auto-sync.sh --path /path/to/repo
```

## 📊 性能优化

### 同步效率
- 增量同步：只处理变更文件
- 智能缓存：缓存Git状态信息
- 并行处理：支持多仓库并行同步

### 资源管理
- 内存控制：限制内存使用
- 超时控制：防止长时间阻塞
- 日志轮转：自动清理旧日志

## 🚀 新增功能

### 1. 智能备份
- 同步前自动备份
- 版本管理和清理
- 备份恢复功能

### 2. 文件过滤
- 排除不需要同步的文件
- 支持通配符和目录
- 可配置的包含/排除规则

### 3. 通知系统
- 邮件通知
- Webhook集成
- 桌面通知

### 4. 钩子脚本
- 同步前执行脚本
- 同步后执行脚本
- 错误处理脚本

## 📈 兼容性

### 支持平台
- ✅ Windows 10/11 (PowerShell 5.1+)
- ✅ Windows Server 2016+ (PowerShell 5.1+)
- ✅ Ubuntu 18.04+ (bash 4.4+)
- ✅ CentOS 7+ (bash 4.2+)
- ✅ macOS 10.14+ (bash 3.2+)

### 依赖要求
- Git 2.20+
- PowerShell 5.1+ (Windows)
- bash 4.2+ (Linux)
- jq 1.6+ (Linux，可选)

## 🔄 迁移指南

### 从旧版本升级
1. 备份现有配置
2. 更新脚本文件
3. 重新运行设置脚本
4. 验证配置和功能

### 配置文件迁移
```bash
# 备份旧配置
cp auto-sync-config.json auto-sync-config.json.backup

# 新配置会自动兼容旧格式
# 新增的配置项使用默认值
```

## 📞 技术支持

### 获取帮助
- 查看日志文件：`sync.log`
- 检查任务状态：
  - Windows: `Get-ScheduledTask -TaskName "GitAutoSync"`
  - Linux: `crontab -l`
- 手动测试同步功能

### 详细文档
- 使用指南：`Git自动同步使用指南.md`
- 技术说明：`全自动同步说明.md`
- 配置参考：`auto-sync-config.json`

---

**🎉 优化完成！现在您的Git同步工具更加稳定、高效和易用！**